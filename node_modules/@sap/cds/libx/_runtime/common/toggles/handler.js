/*
 * addition for feature toggles
 */
module.exports = cds => {
  if (!cds.requires.toggles) return (req, res, next) => next()

  return (req, res, next) => {
    // inject features from dwc header
    const fth = req.headers['dwc-product-configuration']
    if (fth) {
      const { features } = JSON.parse(Buffer.from(fth, 'base64').toString('utf-8'))
      req.features = features
        .filter(f => f.enabled)
        .map(f => f.name)
        .sort((a, b) => a.localeCompare(b))
      Object.freeze(req.features)
    }

    next()
  }
}
