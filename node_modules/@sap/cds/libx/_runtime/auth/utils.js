const cds = require('../cds')

const UNAUTHORIZED = { statusCode: 401, code: '401', message: 'Unauthorized' }
const FORBIDDEN = { statusCode: 403, code: '403', message: 'Forbidden' }

const getRequiresAsArray = definition => {
  const requires = []

  if (definition['@requires']) {
    if (Array.isArray(definition['@requires'])) requires.push(...definition['@requires'])
    else requires.push(definition['@requires'])
  }

  const { restrict_all_services: restrictAllServices } = cds.env.requires.auth || {}
  if (!requires.length && definition.kind === 'service' && restrictAllServices) requires.push('authenticated-user')

  return requires
}

const isRestricted = srv => {
  const envAuth = cds.env.requires.auth
  if (envAuth && envAuth.restrict_all_services) return true
  if (srv.definition['@requires']) return true

  const entities = srv.entities
  const entitiesKeys = Object.keys(entities)

  return !!(
    entitiesKeys.some(entity => entities[entity]['@requires'] || entities[entity]['@restrict']) ||
    entitiesKeys.some(entity => {
      const actions = entities[entity].actions
      actions && Object.keys(actions).some(action => actions[action]['@requires'] || actions[action]['@restrict'])
    }) ||
    Object.keys(srv.operations).some(
      operation => srv.operations[operation]['@requires'] || srv.operations[operation]['@restrict']
    )
  )
}

module.exports = {
  UNAUTHORIZED,
  FORBIDDEN,
  getRequiresAsArray,
  isRestricted
}
