const cds = require('../../../../cds')
const LOG = cds.log('odata')

const { toODataResult } = require('../utils/result')
const { normalizeError } = require('../../../../common/error/frontend')

const _getMetadata4Tenant = async (tenant, locale, service) => {
  return await cds.mtx.getEdmx(tenant, service.name, locale)
}

/**
 * Provide localized metadata handler.
 *
 * @param {object} service
 * @returns {Function}
 */
const metadata = service => {
  return async (odataReq, odataRes, next) => {
    const req = odataReq.getIncomingRequest()
    const tenant = req.user && req.user.tenant
    // REVISIT: can we take locale from user, or is there some odata special wrt metadata?
    const locale = odataRes.getContract().getLocale()

    try {
      let edmx

      if (cds._mtxEnabled && service._isExtended) {
        edmx = await _getMetadata4Tenant(tenant, locale, service)
      }

      if (!edmx) {
        edmx = cds.localize(
          service.model,
          locale,
          // REVISIT: we could cache this in a weak map
          cds.compile.to.edmx(service.model, { service: service.definition.name })
        )
      }

      return next(null, toODataResult(edmx))
    } catch (e) {
      if (LOG._error) {
        e.message = 'Unable to get EDMX for tenant ' + tenant + ' due to error: ' + e.message
        LOG.error(e)
      }
      // return 503 to client
      const { error, statusCode } = normalizeError(Object.assign(e, { statusCode: 503 }), req)
      return next(Object.assign(error, { statusCode }))
    }
  }
}

module.exports = metadata
