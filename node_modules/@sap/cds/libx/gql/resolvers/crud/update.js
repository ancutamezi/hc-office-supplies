const cds = require('../../../../lib')

const { ARGUMENT } = require('../../constants/adapter')
const { getArgumentByName, astToColumns, astToWhere, astToEntries } = require('../parse/ast2cqn')
const { entriesStructureToEntityStructure } = require('./utils')

module.exports = async (service, entityFQN, selection) => {
  const filter = getArgumentByName(selection.arguments, ARGUMENT.FILTER)

  const queryBeforeUpdate = service.read(entityFQN)
  queryBeforeUpdate.columns(astToColumns(selection.selectionSet.selections))

  if (filter) {
    queryBeforeUpdate.where(astToWhere(filter))
  }

  const query = service.update(entityFQN)

  if (filter) {
    query.where(astToWhere(filter))
  }

  const input = getArgumentByName(selection.arguments, ARGUMENT.INPUT)
  const entries = entriesStructureToEntityStructure(service, entityFQN, astToEntries(input))
  query.with(entries)

  let resultBeforeUpdate
  const result = await service.tx(async tx => {
    cds.context = tx
    // read needs to be done before the update, otherwise the where clause might become invalid (case that properties in where clause are updated by the mutation)
    resultBeforeUpdate = await tx.run(queryBeforeUpdate)

    if (resultBeforeUpdate.length === 0) {
      return []
    }

    return tx.run(query)
  })

  // Merge selected fields with updated data
  return resultBeforeUpdate.map(original => ({ ...original, ...result }))
}
