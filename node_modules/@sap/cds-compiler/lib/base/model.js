'use strict';

const queryOps = {
  query: 'select',                // TODO: rename to SELECT
  union: 'union',
  intersect: 'union',
  except: 'union',
  minus: 'union',
  subquery: 'union',            // for (subquery) with ORDER BY or LIMIT/OFFSET
}

/**
 * Object of all available beta flags that will be enabled/disabled by `--beta-mode`
 * through cdsc.  Only intended for INTERNAL USE.
 * NOT to be used by umbrella, etc.
 *
 * @type {{[flag: string]: boolean}} Indicates whether it is enabled by --beta-mode or not.
 * @private
 */
const availableBetaFlags = {
  // enabled by --beta-mode
  toRename: true,
  addTextsLanguageAssoc: true,
  assocsWithParams: true,
  hanaAssocRealCardinality: true,
  mapAssocToJoinCardinality: true,
  ignoreAssocPublishingInUnion: true,
  nestedProjections: true,
  enableUniversalCsn: true,
  // disabled by --beta-mode
  nestedServices: false,
};

/**
 * Test for early-adaptor feature, stored in option `beta`(new-style) / `betaMode`(old-style)
 * With that, the value of `beta` is a dictionary of feature=>Boolean.
 *
 * Beta features cannot be used when options.deprecated is set.
 *
 * A feature always needs to be provided - otherwise false will be returned.
 *
 * Please do not move this function to the "option processor" code.
 *
 * @param {object} options Options
 * @param {string} feature Feature to check for
 * @returns {boolean}
 */
function isBetaEnabled( options, feature ) {
  const beta = options.beta || options.betaMode;
  return beta && typeof beta === 'object' && !options.deprecated && feature && beta[feature];
}

/**
 * Test for deprecated feature, stored in option `deprecated`.
 * With that, the value of `deprecated` is a dictionary of feature=>Boolean.
 * If no `feature` is provided, checks if any deprecated option is set.
 *
 * Please do not move this function to the "option processor" code.
 *
 * @param {object} options Options
 * @param {string} [feature] Feature to check for
 * @returns {boolean}
 */
function isDeprecatedEnabled( options, feature = null ) {
  const { deprecated } = options;
  if (!feature)
    return !!deprecated;
  return deprecated && typeof deprecated === 'object' && deprecated[feature];
}

// Apply function `callback` to all artifacts in dictionary
// `model.definitions`.  See function `forEachGeneric` for details.
function forEachDefinition( model, callback ) {
  forEachGeneric( model, 'definitions', callback );
}

// Apply function `callback` to all members of object `obj` (main artifact or
// parent member).  Members are considered those in dictionaries `elements`,
// `enum`, `actions` and `params` of `obj`, `elements` and `enums` are also
// searched inside property `items` (array of).  See function `forEachGeneric`
// for details.
function forEachMember( construct, callback, target ) {
  let obj = construct;
  while (obj.items)
    obj = obj.items;
  forEachGeneric( target || obj, 'elements', callback );
  forEachGeneric( obj, 'enum', callback );
  forEachGeneric( obj, 'foreignKeys', callback );
  forEachGeneric( construct, 'actions', callback );
  forEachGeneric( construct, 'params', callback );
  if (construct.returns)
    callback( construct.returns, '', 'params' );

}

// Apply function `callback` to all objects in dictionary `dict`, including all
// duplicates (found under the same name).  Function `callback` is called with
// the following arguments: the object, the name, and -if it is a duplicate-
// the array index and the array containing all duplicates.
function forEachGeneric( obj, prop, callback ) {
  let dict = obj[prop];
  for (let name in dict) {
    obj = dict[name];
    callback( obj, name, prop );
    if (Array.isArray(obj.$duplicates)) // redefinitions
      obj.$duplicates.forEach( o => callback( o, name, prop ) )
  }
}

const forEachInOrder = forEachGeneric;

/**
 * Like `obj.prop = value`, but not contained in JSON / CSN
 * It's important to set enumerable explicitly to false (although 'false' is the default),
 * as else, if the property already exists, it keeps the old setting for enumerable.
 *
 * @param {object} obj
 * @param {string} prop
 * @param {any} value
 */
function setProp (obj, prop, value) {
  let descriptor = { value, configurable: true, writable: true, enumerable: false };
  Object.defineProperty( obj, prop, descriptor );
  return value;
}


module.exports = {
  isBetaEnabled,
  availableBetaFlags,
  isDeprecatedEnabled,
  queryOps,
  forEachDefinition,
  forEachMember,
  forEachGeneric,
  forEachInOrder,
  setProp,
};
